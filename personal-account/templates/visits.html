{% extends "base.html" %}

{% block title %}Посещения - Личный кабинет{% endblock %}
{% block page_title %}История посещений{% endblock %}
{% block page_subtitle %}Ваша активность на платформе{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1">Всего посещений</p>
                    <h3 class="mb-0" id="total-visits">-</h3>
                </div>
                <div class="icon primary">
                    <i class="bi bi-calendar-check"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1">За этот месяц</p>
                    <h3 class="mb-0" id="month-visits">-</h3>
                </div>
                <div class="icon success">
                    <i class="bi bi-calendar-month"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1">Уникальных уроков</p>
                    <h3 class="mb-0" id="unique-lessons">-</h3>
                </div>
                <div class="icon warning">
                    <i class="bi bi-collection-play"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Все посещения</h5>
        <div class="d-flex gap-2">
            <input type="date" class="form-control" id="filter-date-from" style="width: 150px;">
            <input type="date" class="form-control" id="filter-date-to" style="width: 150px;">
            <button class="btn btn-outline-primary" id="apply-filter">
                <i class="bi bi-funnel"></i>
            </button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover" id="visits-table">
            <thead>
                <tr>
                    <th>Урок</th>
                    <th>Дата и время</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody id="visits-tbody">
                <tr>
                    <td colspan="3" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <nav>
        <ul class="pagination justify-content-center mb-0" id="pagination">
        </ul>
    </nav>
</div>

<!-- Handlebars Templates -->
{% raw %}
<script id="visits-rows-template" type="text/x-handlebars-template">
    {{#if visits.length}}
        {{#each visits}}
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="icon warning me-3" style="width: 40px; height: 40px; font-size: 16px; border-radius: 8px;">
                        <i class="bi bi-play-circle"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">Урок #{{lesson_id}}</h6>
                        <small class="text-muted">ID: {{id}}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="d-block">{{formatDate visited_at}}</span>
                <small class="text-muted">{{formatTime visited_at}}</small>
            </td>
            <td>
                <span class="badge bg-success">Просмотрен</span>
            </td>
        </tr>
        {{/each}}
    {{else}}
        <tr>
            <td colspan="3" class="text-center py-5">
                <i class="bi bi-calendar-x text-muted" style="font-size: 48px;"></i>
                <p class="text-muted mt-3">Посещений пока нет</p>
            </td>
        </tr>
    {{/if}}
</script>
{% endraw %}
{% endblock %}

{% block extra_js %}
<script>
    Handlebars.registerHelper('formatDate', function(dateString) {
        if (!dateString) return 'Неизвестно';
        const date = new Date(dateString);
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
    });
    
    Handlebars.registerHelper('formatTime', function(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit'
        });
    });

    const visitsRowsTemplate = Handlebars.compile(document.getElementById('visits-rows-template').innerHTML);
    
    let allVisits = [];

    async function loadVisits() {
        const token = API.getToken();
        
        if (!token) {
            document.getElementById('visits-tbody').innerHTML = visitsRowsTemplate({ visits: [] });
            document.getElementById('total-visits').textContent = '0';
            document.getElementById('month-visits').textContent = '0';
            document.getElementById('unique-lessons').textContent = '0';
            return;
        }
        
        try {
            const response = await API.get('/visits');
            allVisits = response.data || [];
            
            // Calculate stats
            document.getElementById('total-visits').textContent = allVisits.length;
            
            const now = new Date();
            const monthVisits = allVisits.filter(v => {
                const date = new Date(v.visited_at);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            });
            document.getElementById('month-visits').textContent = monthVisits.length;
            
            const uniqueLessons = new Set(allVisits.map(v => v.lesson_id)).size;
            document.getElementById('unique-lessons').textContent = uniqueLessons;
            
            renderVisits(allVisits);
            
        } catch (error) {
            console.error('Failed to load visits:', error);
            showToast('Ошибка загрузки посещений', 'danger');
            document.getElementById('visits-tbody').innerHTML = visitsRowsTemplate({ visits: [] });
        }
    }

    function renderVisits(visits) {
        document.getElementById('visits-tbody').innerHTML = visitsRowsTemplate({ visits });
    }

    // Filter by date
    document.getElementById('apply-filter').addEventListener('click', () => {
        const from = document.getElementById('filter-date-from').value;
        const to = document.getElementById('filter-date-to').value;
        
        let filtered = allVisits;
        
        if (from) {
            const fromDate = new Date(from);
            filtered = filtered.filter(v => new Date(v.visited_at) >= fromDate);
        }
        
        if (to) {
            const toDate = new Date(to);
            toDate.setHours(23, 59, 59);
            filtered = filtered.filter(v => new Date(v.visited_at) <= toDate);
        }
        
        renderVisits(filtered);
    });

    document.addEventListener('DOMContentLoaded', loadVisits);
</script>
{% endblock %}
