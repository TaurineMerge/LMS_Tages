@startuml C4_Container_LMS_System_DDD
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title Диаграмма контейнеров - LMS (Система управления обучением)
LAYOUT_WITH_LEGEND()

' Внешние акторы
Person(student, "Гость", "Незарегистрированный пользователь, просматривающий курсы и уроки")
Person(admin, "Администратор/Преподаватель", "Аутентифицированный пользователь, управляющий контентом")
Person(auth_user, "Аутентифицированный студент", "Зарегистрированный пользователь, проходящий курсы и тесты")

' Граница системы
System_Boundary(lms_system, "Система LMS") {
    
    ' Единый entry point - Nginx
    Container(nginx, "nginx", "Reverse Proxy / Router", "Единая точка входа для всей системы. Принимает все HTTP/HTTPS запросы и маршрутизирует их на соответствующие микросервисы по портам:\n- /api/public/* → public-side:3000\n- /api/admin/* → admin-panel:4000\n- /api/personal/* → personal-account:8000\n- /api/tests/* → testing:8085\n- /auth/* → keycloak:8080\nОбеспечивает SSL-терминацию, балансировку нагрузки.")
  
    ' Контейнеры микросервисов
    Container(public_side, "Public Side", "Go, REST API", "Bounded Context: Публичный каталог. Обеспечивает только чтение курсов и уроков для неаутентифицированных пользователей. GET-запросы к /api/public/courses, /api/public/lessons. Использует CQRS для разделения чтения и записи.")
    
    Container(admin_panel, "Admin Panel", "Go, REST API", "Bounded Context: Управление контентом. Позволяет администраторам управлять образовательным контентом (CRUD). Состояния курсов: черновик, опубликован. Агрегаты: Course, Lesson.")
    
    Container(personal_account, "Personal Account", "Python, REST API", "Bounded Context: Прогресс обучения. Управляет профилями пользователей, отслеживает прогресс, хранит статистику. Агрегаты: UserProfile, Progress, Certificate.")
    
    Container(testing_system, "Testing System", "Java, REST API", "Bounded Context: Тестирование. Обрабатывает образовательные тесты, проверяет ответы, рассчитывает результаты. Агрегаты: Test, Question, Result.")
    
    ' Сервис аутентификации
    Container(keycloak, "Keycloak", "Сервер аутентификации", "Обеспечивает аутентификацию и авторизацию на основе JWT. Выдаёт токены с ролями пользователя (студент/админ). Отдельный bounded context: Identity & Access.")
    
    ' Базы данных
    ContainerDb(postgres_lms, "PostgreSQL LMS", "PostgreSQL", "Хранилище данных приложения с разделением по схемам:\n- public_schema: курсы, уроки (read-optimized)\n- admin_schema: контент, черновики\n- personal_schema: пользователи, прогресс\n- testing_schema: тесты, результаты")
    
    ContainerDb(postgres_auth, "PostgreSQL Auth", "PostgreSQL", "Хранилище данных аутентификации для Keycloak:\n- Пользователи и их учетные данные\n- Роли и разрешения\n- Клиенты OAuth2\n- Сессии и токены")
}

' === ПОТОКИ ДАННЫХ ===

' 1. Все клиенты подключаются через Nginx
Rel(student, nginx, "Просматривает курсы/уроки", "HTTPS /api/public/*")
Rel(admin, nginx, "Управляет контентом, авторизуется", "HTTPS /api/admin/*, /auth/*")
Rel(auth_user, nginx, "Проходит обучение, авторизуется", "HTTPS /api/personal/*, /api/tests/*, /auth/*")

' 2. Nginx маршрутизирует на микросервисы
Rel(nginx, public_side, "Проксирует /api/public/*", "HTTP (внутренняя сеть)")
Rel(nginx, admin_panel, "Проксирует /api/admin/*", "HTTP")
Rel(nginx, personal_account, "Проксирует /api/personal/*", "HTTP")
Rel(nginx, testing_system, "Проксирует /api/tests/*", "HTTP")
Rel(nginx, keycloak, "Проксирует /auth/*", "HTTP")

' 3. Keycloak использует свою БД для аутентификации
Rel(keycloak, postgres_auth, "Хранит пользователей, роли, токены", "JDBC")

' 4. Потоки аутентификации (прямые вызовы Keycloak через Nginx)
Rel(admin, nginx, "Проходит аутентификацию", "HTTPS /auth")
Rel(auth_user, nginx, "Проходит аутентификацию", "HTTPS /auth")

' 5. Проверка аутентификации микросервисами
Rel(admin_panel, keycloak, "Валидирует JWT, проверяет роли", "HTTP /auth/verify")
Rel(personal_account, keycloak, "Валидирует JWT, получает user_id", "HTTP /auth/verify")
Rel(testing_system, keycloak, "Валидирует JWT, проверяет доступ", "HTTP /auth/verify")

' 6. Доступ к данным приложения (DDD bounded contexts)
Rel(public_side, postgres_lms, "Чтение: только опубликованные курсы", "SQL (public_schema)")
Rel(admin_panel, postgres_lms, "CRUD: контент, черновики: course_b, test_d, category_d", "SQL (admin_schema)")
Rel(personal_account, postgres_lms, "Получение профиля студента (student_s)", "SQL (personal_schema)")
Rel(testing_system, postgres_lms, "CRUD: тесты, результаты: test_d, test_attempt_b, certificate_b", "SQL (testing_schema)")
Rel(postgres_lms, public_side,  "Чтение: только опубликованные курсы", "SQL (public_schema)")
Rel( postgres_lms, admin_panel, "CRUD: контент, черновики: course_b, test_d, category_d", "SQL (admin_schema)")
Rel( postgres_lms, personal_account, "Получение профиля студента (student_s)", "SQL (personal_schema)")
Rel(postgres_lms, testing_system, "CRUD: тесты, результаты: test_d, test_attempt_b, certificate_b", "SQL (testing_schema)")

' 7. Межсервисное взаимодействие (синхронное, DDD)
Rel(personal_account, postgres_lms, "Получает данные курса для прогресса", "REST /api/public/courses/{id}")

' === ОПИСАНИЯ И ПРИМЕЧАНИЯ ===

note right of nginx 
**Конфигурация маршрутизации:**
location /api/public/ {
    proxy_pass http://public-side:3000;
}
location /api/admin/ {
    proxy_pass http://admin-panel:4000;
}
location /api/personal/ {
    proxy_pass http://personal-account:8000;
}
location /api/tests/ {
    proxy_pass http://testing:8085;
}
location /auth/ {
    proxy_pass http://keycloak:8080;
}
end note

note right of keycloak 
**DDD Bounded Context:**
Identity & Access Management
- Отдельный контекст аутентификации
- Собственная изолированная БД
- Хранение учетных данных пользователей
- Управление ролями и правами
- Выдача и валидация JWT-токенов
end note

note right of postgres_auth 
**Изоляция данных аутентификации:**
- Отдельная БД для безопасности
- Только Keycloak имеет доступ
- Шифрование чувствительных данных
- Регулярное резервное копирование
- Аудит доступа
end note

note right of postgres_lms 
**Разделение данных по схемам:**
Каждый bounded context имеет свою схему
- Изоляция данных доменов
- Собственные миграции
- Оптимизация под конкретные запросы
end note

SHOW_LEGEND()
@enduml