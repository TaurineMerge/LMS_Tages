<script>
let questionCounter = {{#if questions}}{{questions.length}}{{else}}1{{/if}};
let answerCounter = {};

// Инициализация счетчиков при загрузке
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация счетчиков ответов для каждого вопроса
    document.querySelectorAll('.question-card').forEach((card, index) => {
        const questionIndex = parseInt(card.dataset.questionIndex);
        const answerCount = card.querySelectorAll('.answer-group').length;
        answerCounter[questionIndex] = answerCount;
    });
    
    // Кнопка добавления нового вопроса
    document.getElementById('add-question-btn').addEventListener('click', function() {
        const newQuestionIndex = questionCounter;
        questionCounter++;
        answerCounter[newQuestionIndex] = 0;
        
        // Создаем HTML для нового вопроса
        const newQuestionHTML = `
            <div class="question-card" data-question-index="${newQuestionIndex}">
                <div class="form-group">
                    <h3>Вопрос ${newQuestionIndex + 1}</h3>
                    <button type="button" class="remove-question-btn" onclick="removeQuestion(${newQuestionIndex})">× Удалить вопрос</button>
                    <textarea name="question[${newQuestionIndex}][text]" placeholder="Введите текст вопроса" required></textarea>
                </div>
                
                <div class="answers-container" id="answers-${newQuestionIndex}">
                    <div class="answer-group">
                        <input type="text" name="question[${newQuestionIndex}][answers][0][text]" placeholder="Текст ответа 1" required>
                        <label>
                            <input type="radio" name="question[${newQuestionIndex}][correct]" value="0" required>
                            Правильный ответ
                        </label>
                    </div>
                    <div class="answer-group">
                        <input type="text" name="question[${newQuestionIndex}][answers][1][text]" placeholder="Текст ответа 2" required>
                        <label>
                            <input type="radio" name="question[${newQuestionIndex}][correct]" value="1" required>
                            Правильный ответ
                        </label>
                    </div>
                </div>
                
                <button type="button" class="add-answer-btn" onclick="addAnswer(${newQuestionIndex})">+ Добавить ответ</button>
            </div>
        `;
        
        document.getElementById('questions-container').insertAdjacentHTML('beforeend', newQuestionHTML);
        answerCounter[newQuestionIndex] = 2;
    });
});

// Функция для добавления ответа
function addAnswer(questionIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerIndex = answerCounter[questionIndex];
    
    const newAnswerHTML = `
        <div class="answer-group">
            <input type="text" name="question[${questionIndex}][answers][${answerIndex}][text]" placeholder="Текст ответа ${answerIndex + 1}" required>
            <label>
                <input type="radio" name="question[${questionIndex}][correct]" value="${answerIndex}" required>
                Правильный ответ
            </label>
        </div>
    `;
    
    answersContainer.insertAdjacentHTML('beforeend', newAnswerHTML);
    answerCounter[questionIndex]++;
}

// Функция для удаления вопроса
function removeQuestion(questionIndex) {
    const questions = document.querySelectorAll('.question-card');
    if (questions.length <= 1) {
        alert('Тест должен содержать хотя бы один вопрос');
        return;
    }
    
    document.querySelector(`[data-question-index="${questionIndex}"]`).remove();
    delete answerCounter[questionIndex];
    
    // Переиндексация оставшихся вопросов
    renumberQuestions();
}

// Переиндексация вопросов после удаления
function renumberQuestions() {
    const remainingQuestions = document.querySelectorAll('.question-card');
    questionCounter = 0;
    
    remainingQuestions.forEach((questionCard, index) => {
        const newIndex = index;
        questionCounter++;
        questionCard.dataset.questionIndex = newIndex;
        
        // Обновляем заголовок
        const title = questionCard.querySelector('h3');
        if (title) title.textContent = `Вопрос ${newIndex + 1}`;
        
        // Обновляем textarea вопроса
        const textarea = questionCard.querySelector('textarea[name^="question"]');
        if (textarea) {
            textarea.name = `question[${newIndex}][text]`;
        }
        
        // Обновляем ответы
        const answerGroups = questionCard.querySelectorAll('.answer-group');
        answerGroups.forEach((group, answerIndex) => {
            const input = group.querySelector('input[type="text"]');
            if (input) {
                input.name = `question[${newIndex}][answers][${answerIndex}][text]`;
                input.placeholder = `Текст ответа ${answerIndex + 1}`;
            }
            
            const radio = group.querySelector('input[type="radio"]');
            if (radio) {
                radio.name = `question[${newIndex}][correct]`;
                radio.value = answerIndex;
            }
        });
        
        // Обновляем идентификаторы контейнеров
        const answersContainer = questionCard.querySelector('.answers-container');
        if (answersContainer) answersContainer.id = `answers-${newIndex}`;
        
        // Обновляем кнопки
        const addButton = questionCard.querySelector('.add-answer-btn');
        if (addButton) addButton.setAttribute('onclick', `addAnswer(${newIndex})`);
        
        const removeButton = questionCard.querySelector('.remove-question-btn');
        if (removeButton) removeButton.setAttribute('onclick', `removeQuestion(${newIndex})`);
    });
    
    // Обновляем счетчики
    const updatedQuestions = document.querySelectorAll('.question-card');
    updatedQuestions.forEach((card, index) => {
        const questionIndex = parseInt(card.dataset.questionIndex);
        const answerCount = card.querySelectorAll('.answer-group').length;
        answerCounter[questionIndex] = answerCount;
    });
}
</script>