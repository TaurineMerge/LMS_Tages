<script>
let questionCounter = {{#if questions}}{{questions.length}}{{else}}1{{/if}};
let answerCounter = {};

// Инициализация счетчиков ответов при загрузке
{{#if questions}}
    {{#each questions}}
    answerCounter[{{@index}}] = {{this.answers.length}};
    {{/each}}
{{else}}
    answerCounter[0] = 2;
{{/if}}

// Функция расчета суммы баллов за ответы в вопросе
function calculateAnswerPoints(questionIndex) {
    const questionCard = document.querySelector(`[data-question-index="${questionIndex}"]`);
    if (!questionCard) return 0;
    
    const answerInputs = questionCard.querySelectorAll('.answer-points-input');
    let total = 0;
    
    answerInputs.forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
    });
    
    const totalDisplay = questionCard.querySelector(`#question-points-${questionIndex}`);
    if (totalDisplay) {
        totalDisplay.textContent = total.toFixed(1);
    }
    
    return total;
}

// Функция для обновления всех расчетов баллов
function updateAllPointsCalculations() {
    let totalTestPoints = 0;
    
    document.querySelectorAll('.question-editor').forEach(card => {
        const questionIndex = parseInt(card.dataset.questionIndex);
        const questionPoints = calculateAnswerPoints(questionIndex);
        totalTestPoints += questionPoints;
    });
    
    // Обновляем общую сумму баллов за тест
    const totalPointsDisplay = document.getElementById('total-test-points');
    if (totalPointsDisplay) {
        totalPointsDisplay.textContent = totalTestPoints.toFixed(1);
    }
    
    return totalTestPoints;
}

// Добавляем обработчики событий для полей ввода баллов
function setupPointsListeners() {
    document.querySelectorAll('.answer-points-input').forEach(input => {
        input.addEventListener('input', function() {
            const questionCard = this.closest('.question-editor');
            const questionIndex = parseInt(questionCard.dataset.questionIndex);
            calculateAnswerPoints(questionIndex);
            updateAllPointsCalculations();
        });
    });
}

// Функция для добавления ответа
function addAnswer(questionIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerIndex = answerCounter[questionIndex] || answersContainer.children.length;
    
    const newAnswerHtml = `
        <div class="answer-group" data-answer-index="${answerIndex}">
            <input type="text" 
                   name="question[${questionIndex}][answers][${answerIndex}][text]" 
                   placeholder="Текст ответа ${answerIndex + 1}" 
                   required>
            
            <div class="answer-points-group">
                <label>Баллы:</label>
                <input type="number" 
                       class="answer-points-input"
                       name="question[${questionIndex}][answers][${answerIndex}][points]" 
                       value="0"
                       min="0"
                       step="1"
                       required>
            </div>
            
            <button type="button" class="btn-danger remove-answer-btn" 
                    onclick="removeAnswer(${questionIndex}, ${answerIndex})"
                    ${answerIndex === 0 ? 'disabled' : ''}>
                × Удалить
            </button>
        </div>
    `;
    
    answersContainer.insertAdjacentHTML('beforeend', newAnswerHtml);
    answerCounter[questionIndex] = (answerCounter[questionIndex] || 0) + 1;
    
    // Добавляем обработчик для нового поля баллов
    const newInput = answersContainer.lastElementChild.querySelector('.answer-points-input');
    if (newInput) {
        newInput.addEventListener('input', function() {
            calculateAnswerPoints(questionIndex);
            updateAllPointsCalculations();
        });
    }
    
    // Пересчитываем баллы
    calculateAnswerPoints(questionIndex);
    updateAllPointsCalculations();
}

// Функция для удаления ответа
function removeAnswer(questionIndex, answerIndex) {
    const answersContainer = document.getElementById(`answers-${questionIndex}`);
    const answerElements = answersContainer.querySelectorAll('.answer-group');
    
    if (answerElements.length <= 2) {
        alert('Вопрос должен содержать минимум 2 ответа');
        return;
    }
    
    if (answerIndex < answerElements.length) {
        answerElements[answerIndex].remove();
        
        // Обновляем индексы оставшихся ответов
        const remainingAnswers = answersContainer.querySelectorAll('.answer-group');
        remainingAnswers.forEach((element, newIndex) => {
            element.dataset.answerIndex = newIndex;
            
            const textInput = element.querySelector('input[type="text"]');
            const pointsInput = element.querySelector('.answer-points-input');
            const removeBtn = element.querySelector('.remove-answer-btn');
            
            if (textInput) {
                textInput.name = `question[${questionIndex}][answers][${newIndex}][text]`;
                textInput.placeholder = `Текст ответа ${newIndex + 1}`;
            }
            
            if (pointsInput) {
                pointsInput.name = `question[${questionIndex}][answers][${newIndex}][points]`;
            }
            
            if (removeBtn) {
                removeBtn.setAttribute('onclick', `removeAnswer(${questionIndex}, ${newIndex})`);
                removeBtn.disabled = newIndex === 0;
            }
        });
        
        answerCounter[questionIndex] = remainingAnswers.length;
        calculateAnswerPoints(questionIndex);
        updateAllPointsCalculations();
    }
}

// Функция для удаления вопроса
function removeQuestion(questionIndex) {
    const questions = document.querySelectorAll('.question-editor');
    if (questions.length <= 1) {
        alert('Тест должен содержать хотя бы один вопрос');
        return;
    }
    
    if (confirm('Вы уверены, что хотите удалить этот вопрос?')) {
        document.querySelector(`[data-question-index="${questionIndex}"]`).remove();
        delete answerCounter[questionIndex];
        
        // Переиндексация оставшихся вопросов
        renumberQuestions();
        updateAllPointsCalculations();
    }
}

// Функция перемещения вопроса вверх
function moveQuestionUp(questionIndex) {
    const questionCard = document.querySelector(`[data-question-index="${questionIndex}"]`);
    const prevCard = questionCard.previousElementSibling;
    
    if (prevCard && prevCard.classList.contains('question-editor')) {
        questionCard.parentNode.insertBefore(questionCard, prevCard);
        renumberQuestions();
    }
}

// Функция перемещения вопроса вниз
function moveQuestionDown(questionIndex) {
    const questionCard = document.querySelector(`[data-question-index="${questionIndex}"]`);
    const nextCard = questionCard.nextElementSibling;
    
    if (nextCard && nextCard.classList.contains('question-editor')) {
        questionCard.parentNode.insertBefore(nextCard, questionCard);
        renumberQuestions();
    }
}

// Переиндексация вопросов
function renumberQuestions() {
    const remainingQuestions = document.querySelectorAll('.question-editor');
    questionCounter = 0;
    
    remainingQuestions.forEach((questionCard, index) => {
        const newIndex = index;
        questionCounter++;
        questionCard.dataset.questionIndex = newIndex;
        
        // Обновляем заголовок
        const title = questionCard.querySelector('h3');
        if (title) title.textContent = `Вопрос ${newIndex + 1}`;
        
        // Обновляем textarea вопроса
        const textarea = questionCard.querySelector('textarea[name^="question"]');
        if (textarea) {
            textarea.name = `question[${newIndex}][text]`;
        }
        
        // Обновляем кнопки управления
        const moveUpBtn = questionCard.querySelector('.btn-move-up');
        if (moveUpBtn) {
            moveUpBtn.setAttribute('onclick', `moveQuestionUp(${newIndex})`);
            moveUpBtn.disabled = newIndex === 0;
        }
        
        const moveDownBtn = questionCard.querySelector('.btn-move-down');
        if (moveDownBtn) {
            moveDownBtn.setAttribute('onclick', `moveQuestionDown(${newIndex})`);
            moveDownBtn.disabled = newIndex === remainingQuestions.length - 1;
        }
        
        const removeBtn = questionCard.querySelector('.btn-remove-question');
        if (removeBtn) {
            removeBtn.setAttribute('onclick', `removeQuestion(${newIndex})`);
            removeBtn.disabled = newIndex === 0;
        }
        
        const addAnswerBtn = questionCard.querySelector('.btn-secondary[onclick^="addAnswer"]');
        if (addAnswerBtn) addAnswerBtn.setAttribute('onclick', `addAnswer(${newIndex})`);
        
        // Обновляем ID контейнера ответов
        const answersContainer = questionCard.querySelector('.answers-container');
        if (answersContainer) answersContainer.id = `answers-${newIndex}`;
        
        // Обновляем ID блока баллов
        const pointsElement = questionCard.querySelector('[id^="question-points-"]');
        if (pointsElement) pointsElement.id = `question-points-${newIndex}`;
        
        // Обновляем ответы
        const answerGroups = questionCard.querySelectorAll('.answer-group');
        answerGroups.forEach((group, answerIndex) => {
            group.dataset.answerIndex = answerIndex;
            
            const textInput = group.querySelector('input[type="text"]');
            const pointsInput = group.querySelector('.answer-points-input');
            const removeAnswerBtn = group.querySelector('.remove-answer-btn');
            
            if (textInput) {
                textInput.name = `question[${newIndex}][answers][${answerIndex}][text]`;
                textInput.placeholder = `Текст ответа ${answerIndex + 1}`;
            }
            
            if (pointsInput) {
                pointsInput.name = `question[${newIndex}][answers][${answerIndex}][points]`;
            }
            
            if (removeAnswerBtn) {
                removeAnswerBtn.setAttribute('onclick', `removeAnswer(${newIndex}, ${answerIndex})`);
                removeAnswerBtn.disabled = answerIndex === 0;
            }
        });
    });
    
    // Обновляем счетчики
    answerCounter = {};
    remainingQuestions.forEach((card, index) => {
        const questionIndex = parseInt(card.dataset.questionIndex);
        const answerCount = card.querySelectorAll('.answer-group').length;
        answerCounter[questionIndex] = answerCount;
    });
}

// Кнопка добавления нового вопроса
function addNewQuestion() {
    const newQuestionIndex = questionCounter;
    
    const newQuestionHtml = `
        <div class="question-editor" data-question-index="${newQuestionIndex}">
            <div class="card">
                <div class="question-header">
                    <h3 style="margin: 0;">Вопрос ${newQuestionIndex + 1}</h3>
                    <div class="question-controls">
                        <button type="button" class="btn-secondary btn-move-up" onclick="moveQuestionUp(${newQuestionIndex})">
                            ↑ Вверх
                        </button>
                        <button type="button" class="btn-secondary btn-move-down" onclick="moveQuestionDown(${newQuestionIndex})">
                            ↓ Вниз
                        </button>
                        <button type="button" class="btn-danger btn-remove-question" onclick="removeQuestion(${newQuestionIndex})">
                            × Удалить
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Текст вопроса *</label>
                    <textarea name="question[${newQuestionIndex}][text]" placeholder="Введите текст вопроса" required></textarea>
                </div>
                
                <div class="points-info">
                    <div class="points-display">
                        <span>Максимум баллов за вопрос:</span>
                        <strong id="question-points-${newQuestionIndex}">0</strong>
                    </div>
                    <small class="points-hint">(ответы с баллами > 0 считаются правильными)</small>
                </div>
                
                <div class="form-group">
                    <label>Варианты ответов</label>
                    <div id="answers-${newQuestionIndex}" class="answers-container"></div>
                    <button type="button" class="btn-secondary" onclick="addAnswer(${newQuestionIndex})">+ Добавить ответ</button>
                </div>
            </div>
        </div>
    `;
    
    // Добавляем новый вопрос
    document.getElementById('questions-container').insertAdjacentHTML('beforeend', newQuestionHtml);
    
    // Добавляем 2 ответа по умолчанию
    addAnswer(newQuestionIndex);
    addAnswer(newQuestionIndex);
    
    // Обновляем счетчики
    questionCounter++;
    
    // Переиндексация
    renumberQuestions();
    updateAllPointsCalculations();
}

// Навигация и действия
function goBack() {
    window.location.href = '/testing/web/tests/new';
}

function createDraft(testId) {
    if (confirm('Создать черновик для редактирования? Текущий тест останется неизменным.')) {
        window.location.href = `/testing/web/tests/${testId}/create-draft`;
    }
}

function deleteEntity(entityId) {
    const isDraft = entityId.startsWith('draft-');
    const entityName = isDraft ? 'черновик' : 'тест';
    const message = isDraft 
        ? 'Удалить черновик? Это действие нельзя отменить.'
        : 'Удалить тест? Все связанные данные будут удалены.';
    
    if (confirm(message)) {
        fetch(`/testing/web/tests/${entityId}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                alert(`${entityName} удален`);
                setTimeout(() => {
                    window.location.href = '/testing/web/tests/new';
                }, 1500);
            } else {
                alert('Ошибка при удалении');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка сети');
        });
    }
}

// Уведомления
function showNotification(message, type = 'info') {
    // Удаляем старые уведомления
    const oldNotifications = document.querySelectorAll('.notification');
    oldNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.innerHTML = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Валидация формы
function validateForm() {
    const title = document.getElementById('title').value.trim();
    if (!title) {
        alert('Введите название теста');
        return false;
    }
    
    const minPoint = document.getElementById('min_point').value;
    if (!minPoint || minPoint < 0) {
        alert('Введите корректный минимальный балл');
        return false;
    }
    
    // Проверка вопросов
    const questions = document.querySelectorAll('[name^="question["]');
    let hasErrors = false;
    
    questions.forEach((question, index) => {
        if (!question.value.trim()) {
            alert(`Вопрос ${index + 1}: введите текст`);
            hasErrors = true;
        }
    });
    
    return !hasErrors;
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    console.log('Test editor loaded with', questionCounter, 'questions');
    
    // Инициализация счетчиков ответов
    document.querySelectorAll('.question-editor').forEach((card, index) => {
        const questionIndex = parseInt(card.dataset.questionIndex);
        const answerCount = card.querySelectorAll('.answer-group').length;
        answerCounter[questionIndex] = answerCount;
    });
    
    // Инициализируем обработчики
    setupPointsListeners();
    updateAllPointsCalculations();
    
    // Кнопка добавления вопроса
    const addBtn = document.getElementById('add-question-btn');
    if (addBtn) {
        addBtn.addEventListener('click', addNewQuestion);
    }
});

// Делаем функции глобальными
window.addAnswer = addAnswer;
window.removeAnswer = removeAnswer;
window.removeQuestion = removeQuestion;
window.moveQuestionUp = moveQuestionUp;
window.moveQuestionDown = moveQuestionDown;
window.goBack = goBack;
window.createDraft = createDraft;
window.deleteEntity = deleteEntity;
window.showNotification = showNotification;
window.validateForm = validateForm;
</script>