user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    # Максимальное количество одновременно открытых соединений на worker
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Формат access-логов
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Выдача файлов
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;

    # Размер хэша для MIME
    types_hash_max_size 2048;

    # Ограничение размера тела запроса
    client_max_body_size 50M;
    client_body_buffer_size 512k;

    # Сжатие ответов
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # Ограничение на количество запросов с одного IP
    limit_req_zone $binary_remote_addr zone=perip:10m rate=5r/s;

    # Upstream блоки  
    upstream keycloak_backend {
        server keycloak:8080 max_fails=3 fail_timeout=20s;
    }

    upstream public_side_backend {
        server public-side:3000 max_fails=3 fail_timeout=20s;
    }

    upstream admin_panel_backend {
        server admin-panel:4000 max_fails=3 fail_timeout=20s;
    }

    upstream personal_account_backend {
        server personal-account:8000 max_fails=3 fail_timeout=20s;
    }

    upstream testing_backend {
        server testing:8085 max_fails=3 fail_timeout=20s;
    }

    upstream jaeger_backend {
        server jaeger:16686 max_fails=3 fail_timeout=20s;
    }

    # HTTP-сервер
    server {
        listen 80;
        server_name localhost;

        # Ограничение количества запросов
        limit_req zone=perip burst=10 nodelay;

    # Перенаправление с /jaeger в /jaeger/
    location = /jaeger {
            return 301 /jaeger/;
        }

        # API Jaeger - ДОЛЖЕН БЫТЬ ПЕРЕД location /jaeger/
        location /jaeger/api/ {
            rewrite ^/jaeger/api/(.*)$ /jaeger/api/$1 break;
            proxy_pass http://jaeger_backend;
            
            # Базовые заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header X-Forwarded-Prefix /jaeger;
            
            # Убираем любые sub_filter для API
            proxy_set_header Accept-Encoding "";
            
            # Убедимся, что API ответы обрабатываются корректно
            proxy_redirect off;
            proxy_pass_request_headers on;
            
        }

        # Статика Jaeger - ДОЛЖЕН БЫТЬ ПЕРЕД location /jaeger/
        location ~ ^/jaeger/static/ {
            # Убираем /jaeger/static/ при проксировании
            rewrite ^/jaeger/static/(.*)$ /static/$1 break;
            proxy_pass http://jaeger_backend;

            # Базовые заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Кэширование статики
            expires 1y;
            add_header Cache-Control "public, immutable";
            
        }

        # favicon для Jaeger - ДОЛЖЕН БЫТЬ ПЕРЕД location /jaeger/
        location ~ ^/jaeger/static/favicon.*\.ico$ {
            rewrite ^/jaeger/static/(.*)$ /static/$1 break;
            proxy_pass http://jaeger_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # favicon.ico для Jaeger
        location = /jaeger/favicon.ico {
            proxy_pass http://jaeger_backend/jaeger/static/favicon-BxcVf0am.ico;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Основной location для Jaeger UI - ДОЛЖЕН БЫТЬ ПОСЛЕДНИМ
        location /jaeger/ {
            # ВАЖНО: слеш в конце!
            proxy_pass http://jaeger_backend/jaeger/;
            
            # Базовые заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header X-Forwarded-Prefix /jaeger;

            # Отключаем сжатие для sub_filter
            proxy_set_header Accept-Encoding "";

            # Перезапись URL в HTML для правильной работы путей
            sub_filter_once off;
            sub_filter_types text/html text/css application/javascript;

            # Замена базового URL в HTML
            sub_filter '<base href="/" />' '<base href="/jaeger/" />';
            
            # Заменяем пути в HTML для корректной работы с префиксом
            sub_filter '"/api' '"/jaeger/api';
            sub_filter '"/static' '"/jaeger/static';
            sub_filter '"/search' '"/jaeger/search';
            sub_filter '"/trace' '"/jaeger/trace';
            sub_filter '"/dependency' '"/jaeger/dependency';
            sub_filter '"/config' '"/jaeger/config';
            sub_filter '"/quality-metrics' '"/jaeger/quality-metrics';
            
            # Обработка favicon и статики - внутри HTML
            sub_filter 'href="./static/' 'href="/jaeger/static/';
            sub_filter 'src="./static/' 'src="/jaeger/static/';
            sub_filter 'href="./favicon' 'href="/jaeger/favicon';
            sub_filter 'href="favicon' 'href="/jaeger/favicon';
            
            # Добавляем debug заголовок
            add_header X-Jaeger-Proxy "fixed";
            
            # Убедимся, что для HTML используется правильный тип контента
            proxy_pass_request_headers on;
        }
        # Keycloak
        location /auth/ {
            proxy_pass http://keycloak_backend;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Исправляем заголовки для правильного формирования путей к ресурсам
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Для правильной работы Keycloak за reverse proxy
            proxy_redirect /auth/ /auth/;
            
            # Заголовки для CORS
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
            add_header Access-Control-Expose-Headers "Content-Length,Content-Range";
            
            # Обработка preflight запросов
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin *;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
                add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }
        
        
        # Отдельный маршрут для статических ресурсов Keycloak
        location ~ ^/auth/resources/ {
            proxy_pass http://keycloak_backend;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Убедимся, что заголовки корректны для статических ресурсов
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Кэширование статических ресурсов
            expires 1h;
            
            # Заголовки для CORS
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
        }
        
        # Маршрут для swagger.json
        location ~ ^/admin/doc/swagger\.json {
            rewrite ^/admin/doc/swagger\.json$ /doc/swagger.json break;
            proxy_pass http://admin-panel:4000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для CORS
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
            
            # Обновление URL-адреса сервера в swagger.json для корректной работы через nginx
            sub_filter '"http://localhost:4000"' '"http://localhost/admin"';
            sub_filter '"servers":\[{"url":"http://localhost:4000"\}\]' '"servers":[{"url":"http://localhost/admin"}]';
            # Обновление host и basePath для корректной работы API через nginx
            sub_filter '"host": "localhost:4000",' '"host": "localhost",';
            sub_filter '"basePath": "/api/v1"' '"basePath": "/admin/api/v1"';
            # Обновление URL-адреса Keycloak для OAuth авторизации
            sub_filter 'http://localhost:8080/realms/teacher/protocol/openid-connect/auth' 'http://localhost/auth/realms/teacher/protocol/openid-connect/auth';
            sub_filter 'http://localhost:8080/realms/teacher/protocol/openid-connect/token' 'http://localhost/auth/realms/teacher/protocol/openid-connect/token';
            sub_filter_types application/json;
            sub_filter_once on;
        }
        
        # Обработка запроса к самому каталогу Swagger UI
        location = /admin/swagger/ {
            proxy_pass http://admin-panel:4000/swagger/index.html;
            include /etc/nginx/includes/proxy_params.conf;
            proxy_set_header Accept-Encoding "";
            
            # Заголовки для корректной работы Swagger UI
            sub_filter_types application/json text/html;
            sub_filter_once off;
            
            # Фильтр для обновления URL-адресов в Swagger UI
            sub_filter 'http://localhost:4000/swagger/' 'http://localhost/admin/swagger/';
            sub_filter 'http://localhost:4000/doc/swagger.json' 'http://localhost/admin/doc/swagger.json';
            sub_filter '"/doc/swagger.json"' '"/admin/doc/swagger.json"';
            sub_filter 'http://localhost:4000' 'http://localhost';
        }
        
        # Перенаправление для корня Swagger UI
        location = /admin/swagger {
            return 301 /admin/swagger/;
        }
        
        # Обработка запросов к Swagger UI
        location ~ ^/admin/swagger/(.*) {
            rewrite ^/admin/swagger/(.*)$ /swagger/$1 break;
            proxy_pass http://admin-panel:4000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для корректной работы Swagger UI
            proxy_set_header Accept-Encoding "";
            sub_filter_types application/json text/html;
            sub_filter_once off;
            
            # Фильтр для обновления URL-адресов в Swagger UI
            sub_filter 'http://localhost:4000/swagger/' 'http://localhost/admin/swagger/';
            sub_filter 'http://localhost:4000/doc/swagger.json' 'http://localhost/admin/doc/swagger.json';
            sub_filter 'http://localhost:4000' 'http://localhost';
        }
        
        # Admin Panel API (для API маршрутов)
        location /admin/api/v1/ {
            rewrite ^/admin/api/v1/(.*) /api/v1/$1 break;
            proxy_pass http://admin-panel:4000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для корректной работы админ-панели
            proxy_set_header Accept-Encoding "";
            proxy_set_header X-Forwarded-Prefix "/admin";
        }
        
        # Admin Panel (должен быть после специфичных маршрутов)
        location /admin/ {
            proxy_pass http://admin-panel:4000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для корректной работы админ-панели
            proxy_set_header Accept-Encoding "";
            proxy_set_header X-Forwarded-Prefix "/admin";
        }

        # Personal Account - MkDocs Tech Docs (статика)
        # Redirect without trailing slash to with trailing slash
        location = /account/docs-tech {
            return 301 /account/docs-tech/;
        }
        
        # Use ^~ to prevent regex locations (e.g. the global file-extension rule)
        # from hijacking asset requests (css/js/fonts) and ensure alias is used.
        location ^~ /account/docs-tech/ {
            alias /var/www/docs-tech/;
            index index.html;
            try_files $uri $uri/ /account/docs-tech/index.html;
        }

        # Personal Account API & Docs
        # Swagger: /account/docs-swagger, /account/redoc, /account/openapi.json
        location /account/docs-swagger {
            proxy_pass http://personal_account_backend/docs-swagger;
            include /etc/nginx/includes/proxy_params.conf;
        }
        location /account/redoc {
            proxy_pass http://personal_account_backend/redoc;
            include /etc/nginx/includes/proxy_params.conf;
        }
        location /account/openapi.json {
            proxy_pass http://personal_account_backend/openapi.json;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Static files for Personal Account (prevent regex match)
        location ^~ /account/static/ {
            proxy_pass http://personal_account_backend/static/;
            include /etc/nginx/includes/proxy_params.conf;
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }

        # API: /account/api/v1/students, /account/api/v1/certificates, etc.
        location /account/ {
            rewrite ^/account/(.*) /$1 break;
            proxy_pass http://personal_account_backend;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Testing service
        location /testing/ {
            rewrite ^/testing/(.*) /$1 break;
            proxy_pass http://testing:8085;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # ===== PUBLIC SIDE SWAGGER CONFIGURATION =====
        # Маршрут для swagger.json publicSide
        location ~ ^/public/doc/swagger\.json {
            rewrite ^/public/doc/swagger\.json$ /doc/swagger.json break;
            proxy_pass http://public-side:3000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для CORS
            add_header Access-Control-Allow-Origin "*";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization";
            
            # Отключаем сжатие для корректной работы sub_filter
            proxy_set_header Accept-Encoding "";
            
            # Обновление URL-адреса сервера в swagger.json для корректной работы через nginx
            # Для Swagger 2.0 используется комбинация host + basePath
            sub_filter '"host": "localhost:3000"' '"host": "localhost"';
            sub_filter '"basePath": "/api/v1"' '"basePath": "/public/api/v1"';
            sub_filter_types application/json;
            sub_filter_once off;
        }
        
        # Обработка запроса к самому каталогу Swagger UI publicSide
        location = /public/swagger/ {
            proxy_pass http://public-side:3000/api/v1/swagger/index.html;
            include /etc/nginx/includes/proxy_params.conf;
            proxy_set_header Accept-Encoding "";
            
            # Заголовки для корректной работы Swagger UI
            sub_filter_types application/json text/html;
            sub_filter_once off;
            
            # Фильтр для обновления URL-адресов в Swagger UI
            sub_filter 'http://localhost:3000/swagger/' 'http://localhost/public/swagger/';
            sub_filter 'http://localhost:3000/doc/swagger.json' 'http://localhost/public/doc/swagger.json';
            sub_filter '"/doc/swagger.json"' '"/public/doc/swagger.json"';
            sub_filter 'http://localhost:3000' 'http://localhost';
        }
        
        # Перенаправление для корня Swagger UI publicSide
        location = /public/swagger {
            return 301 /public/swagger/;
        }
        
        # Обработка запросов к Swagger UI publicSide
        location ~ ^/public/swagger/(.*) {
            rewrite ^/public/swagger/(.*)$ /api/v1/swagger/$1 break;
            proxy_pass http://public-side:3000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для корректной работы Swagger UI
            proxy_set_header Accept-Encoding "";
            sub_filter_types application/json text/html;
            sub_filter_once off;
            
            # Фильтр для обновления URL-адресов в Swagger UI
            sub_filter 'http://localhost:3000/swagger/' 'http://localhost/public/swagger/';
            sub_filter 'http://localhost:3000/doc/swagger.json' 'http://localhost/public/doc/swagger.json';
            sub_filter 'http://localhost:3000' 'http://localhost';
        }
        
        # Public Side API (для API маршрутов)
        location /public/api/v1/ {
            rewrite ^/public/api/v1/(.*) /api/v1/$1 break;
            proxy_pass http://public-side:3000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для корректной работы public side
            proxy_set_header Accept-Encoding "";
            proxy_set_header X-Forwarded-Prefix "/public";
        }
        
        # Public Side (должен быть после специфичных маршрутов)
        location /public/ {
            proxy_pass http://public-side:3000;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Заголовки для корректной работы public side
            proxy_set_header Accept-Encoding "";
            proxy_set_header X-Forwarded-Prefix "/public";
        }
        # ===== END PUBLIC SIDE SWAGGER CONFIGURATION =====

        # Public side static files - ДОЛЖЕН БЫТЬ ПЕРЕД location /
        location /static/ {
            proxy_pass http://public-side:3000/static/;
            include /etc/nginx/includes/proxy_params.conf;
            
            # Отключаем кэширование для CSS/JS файлов (для разработки)
            # add_header Cache-Control "no-cache, no-store, must-revalidate";
            # add_header Pragma "no-cache";
            # add_header Expires "0";
            
            # Принудительно устанавливаем правильные MIME типы
            location ~* \.css$ {
                proxy_pass http://public-side:3000;
                include /etc/nginx/includes/proxy_params.conf;
                add_header Content-Type "text/css; charset=utf-8";
                # add_header Cache-Control "no-cache, no-store, must-revalidate";
                # add_header Pragma "no-cache";
                # add_header Expires "0";
            }
            
            location ~* \.js$ {
                proxy_pass http://public-side:3000;
                include /etc/nginx/includes/proxy_params.conf;
                add_header Content-Type "application/javascript; charset=utf-8";
                # add_header Cache-Control "no-cache, no-store, must-revalidate";
                # add_header Pragma "no-cache";
                # add_header Expires "0";
            }
        }

        # Public side (default route)
        location / {
            proxy_pass http://public-side:3000;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Health check
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # Кэширование статики
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }
    }
}