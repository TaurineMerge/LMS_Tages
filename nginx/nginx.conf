user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    # Максимальное количество одновременно открытых соединений на worker
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Формат access-логов
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Выдача файлов
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    keepalive_timeout 65;

    # Размер хэша для MIME
    types_hash_max_size 2048;

    # Ограничение размера тела запроса
    client_max_body_size 50M;
    client_body_buffer_size 512k;

    # Сжатие ответов
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss;

    # Ограничение на количество запросов с одного IP
    limit_req_zone $binary_remote_addr zone=perip:10m rate=5r/s;

    # Upstream блоки  
    upstream keycloak_backend {
        server keycloak:8080 max_fails=3 fail_timeout=20s;
    }

    upstream public_side_backend {
        server public-side:3000 max_fails=3 fail_timeout=20s;
    }

    upstream admin_panel_backend {
        server admin-panel:4000 max_fails=3 fail_timeout=20s;
    }

    upstream personal_account_backend {
        server personal-account:8000 max_fails=3 fail_timeout=20s;
    }

    upstream testing_backend {
        server testing:8085 max_fails=3 fail_timeout=20s;
    }

    # HTTP-сервер
    server {
        listen 80;
        server_name localhost;

        # Ограничение количества запросов
        limit_req zone=perip burst=10 nodelay;

        # Keycloak
        location /auth/ {
            proxy_pass http://keycloak_backend/;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Admin Panel
        location /admin/ {
            proxy_pass http://admin_panel_backend/;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Personal Account API & Docs
        # Docs: /account/docs, /account/redoc
        location /account/docs {
            proxy_pass http://personal_account_backend/docs;
            include /etc/nginx/includes/proxy_params.conf;
        }
        location /account/redoc {
            proxy_pass http://personal_account_backend/redoc;
            include /etc/nginx/includes/proxy_params.conf;
        }
        location /account/openapi.json {
            proxy_pass http://personal_account_backend/openapi.json;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Static files for Personal Account (prevent regex match)
        location ^~ /account/static/ {
            proxy_pass http://personal_account_backend/static/;
            include /etc/nginx/includes/proxy_params.conf;
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }

        # API: /account/api/v1/students, /account/api/v1/certificates, etc.
        location /account/ {
            proxy_pass http://personal_account_backend/;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Testing service
        location /testing/ {
            proxy_pass http://testing_backend/;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Public side
        location / {
            proxy_pass http://public_side_backend/;
            include /etc/nginx/includes/proxy_params.conf;
        }

        # Health check
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # Кэширование статики
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
            expires 30d;
            add_header Cache-Control "public, no-transform";
        }
    }
}
